<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI River Explorer</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* Floating Search Box Style */
        .search-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000; /* On top of the map */
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            width: 350px;
        }
        .search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .search-btn {
            width: 100%;
            padding: 10px;
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .search-btn:hover { background-color: #005a9e; }
        .status { margin-top: 10px; font-size: 0.9em; color: #666; }
        .result-item { border-bottom: 1px solid #eee; padding: 5px 0; font-size: 0.9em; }
    </style>
</head>
<body>

    <div class="search-container">
        <h3>ðŸŒŠ AI River Explorer</h3>
        <p>Ask anything about rivers (e.g., "tidal rivers", "short streams")</p>
        <input type="text" id="queryInput" class="search-box" placeholder="Type your query..." value="coastal rivers">
        <button onclick="searchRivers()" class="search-btn">Ask AI Agent</button>
        <div id="status" class="status">Ready.</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. Initialize Map (Centered on UK)
        const map = L.map('map').setView([54.5, -3.0], 6);

        // 2. Add Base Layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        let geoJsonLayer = null;

        async function searchRivers() {
            const query = document.getElementById('queryInput').value;
            const statusDiv = document.getElementById('status');
            
            if (!query) return;

            statusDiv.innerHTML = "Thinking (Calling Python AI)...";
            statusDiv.style.color = "blue";

            try {
                // Call your .NET API
                const response = await fetch(`https://localhost:7075/api/AI/search?query=${encodeURIComponent(query)}`);
                
                if (!response.ok) throw new Error("API Error");

                const result = await response.json();
                
                // Update Status
                statusDiv.innerHTML = `Found <b>${result.count}</b> rivers matching semantics.`;
                statusDiv.style.color = "green";

                // Clear previous results
                if (geoJsonLayer) map.removeLayer(geoJsonLayer);

                // Convert API Data to GeoJSON FeatureCollection
                const features = result.data.map(item => {
                    return {
                        "type": "Feature",
                        "properties": {
                            "name": item.river.watercourse_Name || "Unnamed River",
                            "score": item.similarityScore,
                            "form": item.river.form,
                            "length": item.river.length
                        },
                        "geometry": item.river.geometry // NetTopologySuite serializes this correctly
                    };
                });

                const geoJsonData = {
                    "type": "FeatureCollection",
                    "features": features
                };

                // Add to Map
                geoJsonLayer = L.geoJSON(geoJsonData, {
                    style: {
                        color: "#ff0000", // Red color for visibility
                        weight: 4,
                        opacity: 0.7
                    },
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup(`
                            <b>${feature.properties.name}</b><br>
                            AI Similarity: ${feature.properties.score.toFixed(4)}<br>
                            Form: ${feature.properties.form}<br>
                            Length: ${feature.properties.length}m
                        `);
                    }
                }).addTo(map);

                // Zoom to results
                if (features.length > 0) {
                    map.fitBounds(geoJsonLayer.getBounds());
                }

            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = "Error connecting to Agent.";
                statusDiv.style.color = "red";
            }
        }
    </script>
</body>
</html>